import streamlit as st
import fitz
import pandas as pd

import json
import time
from openai import OpenAI
from lark_oapi import Client
from lark_oapi.api.bitable.v1 import *
st.set_page_config(page_title="è®ºæ–‡å‚æ•°å…¨è‡ªåŠ¨æå–å™¨", layout="wide")
st.title("ğŸ“š è®ºæ–‡å‚æ•°å…¨è‡ªåŠ¨æå– & é£ä¹¦åŒæ­¥")

# è¯»å–æœ¬åœ°çš„å…³é”®è¯åˆ—è¡¨
try:
    keywords_df = pd.read_csv("å‚æ•°å…³é”®å­—.xlsx - Sheet1.csv")
    keywords_list = keywords_df['å‚æ•°ï¼ˆä¸­æ–‡ï¼‰'].tolist()
    st.sidebar.success(f"å·²åŠ è½½ {len(keywords_list)} ä¸ªå…³é”®è¯")
except:
    st.sidebar.error("è¯·ç¡®ä¿ 'å‚æ•°å…³é”®å­—.xlsx - Sheet1.csv' æ–‡ä»¶åœ¨è„šæœ¬åŒç›®å½•ä¸‹")
    keywords_list = []

uploaded_files = st.file_uploader("ä¸Šä¼ è®ºæ–‡ PDF (æ”¯æŒæ‰¹é‡æ‹–å…¥)", type="pdf", accept_multiple_files=True)

if st.button("å¼€å§‹æå–å¹¶æäº¤è‡³é£ä¹¦"):
    if not uploaded_files:
        st.warning("è¯·å…ˆä¸Šä¼  PDF æ–‡ä»¶")
    elif not keywords_list:
        st.error("å…³é”®è¯åˆ—è¡¨ä¸ºç©º")
    else:
        progress_bar = st.progress(0)
        for i, pdf_file in enumerate(uploaded_files):
            with st.status(f"æ­£åœ¨å¤„ç†: {pdf_file.name}...", expanded=True) as status:
                # 1. æå–æ–‡æœ¬
                st.write("æ­£åœ¨è¯»å–æ–‡æœ¬...")
                text = extract_pdf_text(pdf_file)
                
                # 2. AI æå–
                st.write("AI æ­£åœ¨æ·±åº¦è§£æå…³é”®è¯æ•°æ®...")
                result = ai_extract_parameters(text, keywords_list)
                
                if result:
                    # æ·»åŠ æ–‡ä»¶åä½œä¸ºè®°å½•å
                    result["è®ºæ–‡æ ‡é¢˜"] = pdf_file.name 
                    
                    # 3. æäº¤é£ä¹¦
                    st.write("æ­£åœ¨å°†æ•°æ®å†™å…¥é£ä¹¦å¤šç»´è¡¨æ ¼...")
                    success = upload_to_feishu(result)
                    
                    if success:
                        status.update(label=f"âœ… {pdf_file.name} å·²åŒæ­¥è‡³é£ä¹¦", state="complete")
                    else:
                        status.update(label=f"âŒ {pdf_file.name} åŒæ­¥é£ä¹¦å¤±è´¥", state="error")
                
                # æ›´æ–°è¿›åº¦æ¡
                progress_bar.progress((i + 1) / len(uploaded_files))
        
        st.balloons()
        st.success("æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼è¯·æ£€æŸ¥ä½ çš„é£ä¹¦å¤šç»´è¡¨æ ¼ã€‚")
